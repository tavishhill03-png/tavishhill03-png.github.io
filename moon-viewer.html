<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Moon Viewer with Tilted Sunlight</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      background: #000;
      height: 100%;
      width: 100%;
    }

    #moon-container {
      position: relative;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
      background: #000;
    }

    /* Vertical phase slider on the left */
    #phase-slider-wrapper {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      z-index: 10;
      display: flex;
      align-items: center;
      justify-content: center;
      pointer-events: none; /* wrapper doesn't block mouse */
    }

    #phase-slider {
      pointer-events: auto;
      width: 150px;          /* length of the slider (rotated) */
      transform: rotate(-90deg);
      -webkit-appearance: none;
      appearance: none;
      background: #333;
      height: 6px;
      border-radius: 3px;
      outline: none;
    }

    #phase-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: #ccc;
      cursor: pointer;
    }

    #phase-slider::-moz-range-thumb {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: #ccc;
      cursor: pointer;
      border: none;
    }
  </style>
</head>
<body>
  <div id="moon-container">
    <div id="phase-slider-wrapper">
      <input
        id="phase-slider"
        type="range"
        min="0"
        max="1"
        step="0.001"
        value="0.25"
      />
    </div>
  </div>

  <!-- Use ES modules so OrbitControls / GLTFLoader work cleanly -->
  <script type="module">
    import * as THREE from 'https://unpkg.com/three@0.159.0/build/three.module.js';
    import { OrbitControls } from 'https://unpkg.com/three@0.159.0/examples/jsm/controls/OrbitControls.js';
    import { GLTFLoader } from 'https://unpkg.com/three@0.159.0/examples/jsm/loaders/GLTFLoader.js';

    let scene, camera, renderer, controls;
    let moon = null;
    let dirLight, ambientLight;
    const sunDir = new THREE.Vector3();

    // Sun elevation: negative = from below the lunar equator
    const SUN_ELEV_DEG = -20;
    const SUN_ELEV_RAD = THREE.MathUtils.degToRad(SUN_ELEV_DEG);

    const container = document.getElementById('moon-container');
    const phaseSlider = document.getElementById('phase-slider');

    init();
    animate();

    function init() {
      scene = new THREE.Scene();

      const width = container.clientWidth;
      const height = container.clientHeight;

      camera = new THREE.PerspectiveCamera(45, width / height, 0.1, 1000);
      camera.position.set(0, 0, 6);

      renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
      renderer.setSize(width, height);
      renderer.setPixelRatio(window.devicePixelRatio || 1);
      renderer.setClearColor(0x000000, 1);
      container.appendChild(renderer.domElement);

      // Lights: dim ambient + directional "Sun"
      ambientLight = new THREE.AmbientLight(0xffffff, 0.15);
      scene.add(ambientLight);

      dirLight = new THREE.DirectionalLight(0xffffff, 2.0);
      dirLight.castShadow = false;
      scene.add(dirLight);

      dirLight.target.position.set(0, 0, 0);
      scene.add(dirLight.target);

      // Initial lighting based on slider default
      updateLightingFromPhase(parseFloat(phaseSlider.value));

      // Orbit controls (no auto-rotation; wheel zoom enabled)
      controls = new OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;
      controls.dampingFactor = 0.05;
      controls.enablePan = false;
      controls.autoRotate = false;
      controls.enableZoom = true;
      controls.minDistance = 2.0;
      controls.maxDistance = 15.0;

      // Load high-res Moon model
      const loader = new GLTFLoader();
      loader.load(
        'the_moon.glb',   // make sure this path is correct relative to this HTML file
        (gltf) => {
          moon = gltf.scene;
          scene.add(moon);

          // Normalize scale so radius ~ 2 units
          const box = new THREE.Box3().setFromObject(moon);
          const size = new THREE.Vector3();
          box.getSize(size);
          const maxDim = Math.max(size.x, size.y, size.z);
          const desiredRadius = 2.0;
          const scaleFactor = (desiredRadius * 2) / maxDim;
          moon.scale.setScalar(scaleFactor);

          // Center model at origin
          const center = new THREE.Vector3();
          box.getCenter(center);
          moon.position.sub(center.multiplyScalar(scaleFactor));

          // Reinforce lighting once Moon is present
          updateLightingFromPhase(parseFloat(phaseSlider.value));
        },
        undefined,
        (error) => {
          console.error('Error loading the_moon.glb:', error);
        }
      );

      // Phase slider
      phaseSlider.addEventListener('input', (e) => {
        const val = parseFloat(e.target.value);
        updateLightingFromPhase(val);
      });

      window.addEventListener('resize', onWindowResize, false);
    }

    function onWindowResize() {
      const width = container.clientWidth;
      const height = container.clientHeight;

      camera.aspect = width / height;
      camera.updateProjectionMatrix();

      renderer.setSize(width, height);
    }

    // phaseValue: 0 → 1
    function updateLightingFromPhase(phaseValue) {
      const phaseRad = phaseValue * Math.PI * 2; // 0 → 2π

      // Direction from Sun toward Moon in Moon coords
      sunDir.set(
        Math.cos(SUN_ELEV_RAD) * Math.cos(phaseRad), // x
        Math.sin(SUN_ELEV_RAD),                      // y (below equator)
        Math.cos(SUN_ELEV_RAD) * Math.sin(phaseRad)  // z
      ).normalize();

      const lightDistance = 50;
      dirLight.position.copy(sunDir).multiplyScalar(lightDistance);

      dirLight.target.position.set(0, 0, 0);
      dirLight.target.updateMatrixWorld();
    }

    function animate() {
      requestAnimationFrame(animate);

      if (controls) controls.update();

      renderer.render(scene, camera);
    }
  </script>
</body>
</html>
